name: Token Diff PR Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "packages/tokens/src/**"
      - "packages/tokens/schemas/**"

jobs:
  token-diff-comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup toolchain
        uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      - name: Generate token diff report
        id: diff
        working-directory: ./tools/diff-generator
        run: |
          # Generate the diff report
          set +e  # Don't exit on command failure
          pnpm tdiff report \
            --otb ${{ github.base_ref }} \
            --ntb ${{ github.head_ref }} \
            --repo ${{ github.repository }} \
            --format markdown \
            --output /tmp/token-diff.md
          exit_code=$?
          set -e  # Re-enable exit on failure

          # Check if the command succeeded and output file exists
          if [ $exit_code -eq 0 ] && [ -f /tmp/token-diff.md ] && [ -s /tmp/token-diff.md ]; then
            echo "diff_generated=true" >> $GITHUB_OUTPUT
            echo "diff_content<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/token-diff.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 0 ]; then
            # Command succeeded but no changes detected
            echo "diff_generated=false" >> $GITHUB_OUTPUT
            echo "diff_content=No token changes detected." >> $GITHUB_OUTPUT
          else
            # Command failed
            echo "diff_generated=error" >> $GITHUB_OUTPUT
            echo "diff_content=Error generating token diff report. Exit code: $exit_code" >> $GITHUB_OUTPUT
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "<!-- token-diff-comment -->"

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.diff.outputs.diff_generated == 'true'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- token-diff-comment -->
            ## 🎨 Token Changes Report

            ${{ steps.diff.outputs.diff_content }}

            ---
            *This comment was automatically generated by the token diff tool. 🤖*
          edit-mode: replace

      - name: Create no changes comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.diff.outputs.diff_generated == 'false'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- token-diff-comment -->
            ## 🎨 Token Changes Report

            No token changes detected in this pull request.

            ---
            *This comment was automatically generated by the token diff tool. 🤖*
          edit-mode: replace

      - name: Create error comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.diff.outputs.diff_generated == 'error'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- token-diff-comment -->
            ## 🎨 Token Changes Report

            ⚠️ **Error**: ${{ steps.diff.outputs.diff_content }}

            Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.

            ---
            *This comment was automatically generated by the token diff tool. 🤖*
          edit-mode: replace
